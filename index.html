<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

</head>
<body>
    <div id = "mainBox">
    <div id = "map">
        <div id="boxName">
            <ul>
                    <li><i class="fas fa-signature"></i></li>
                    <li> <input type="text" maxlength="11" name="" id="textName"></li>
                    <li><input type="button" id="addName" value="Add"></i></li>
                </ul>
        </div>
        <div id="boxMarkerSrc">
            <ul>
                <li><i class="fas fa-map-marker"></i></li>
                <li> <input type="text" name=""  id="avatarSrc"></li>
                <li><input type="button" id="addAvatar" value="Add"></i></li>
            </ul>
           
        </div>
        <div id = "mapView"></div>
        <div id = "position">
            <ul>
                <li> <h5>x = </h6>  <p id="Lat"> </p> </li>
                <li> <h5>y = </h6> <p id="Lng"> </p></li>
            </ul>

        </div>
        <div id = "nick"> <p>Anonimus</p> </div>
    </div>
    <div id = "czat">
       
        
    </div>
    <div id = "addMessage"> <input type="text" name="" id="textMessage"><input type="button" id ="sendMessage" value="Send"></div>
    </div>
</body>


<script>

let marker;
let position;
let map;
let nick = "Anonimus";
let markerSrc;
let players = {};
var ws;

//funkcja odpowiedzialna za poruszanie markerem za pomocą przucisków w,a,s,d
document.addEventListener("keydown" , (e)=>
{
    
    switch(e.keyCode)
    {
        case 87:   position.lat+=0.05;
        break;
        case 83:  position.lat-=0.05;
        break;
        case 68:  position.lng+=0.05;
        break;
        case 65:  position.lng-=0.05;
        break;
        break;
        
    }
    let wsData = {
        lat: position.lat,
        lng: position.lng,
        id: nick
    }
    marker.setPosition( position );
    map.setCenter(position);
  

    ws.send(JSON.stringify(wsData))
    displayPosition();
    
})
// funkcja odpowiedzialna za przesuwanie markera za pomocą myszki
document.querySelector("#mapView").addEventListener("mousemove",(e)=>
    {
        
    }
    

)

//funkcja dodająca nick gracza 
document.querySelector("#addName").addEventListener('click', (e)=>
{
    if(!document.querySelector("#textName").value==" ")
    nick= document.querySelector("#textName").value;
    else
    nick = "Anonimus";



    document.querySelector("#nick p").innerHTML = nick;
    document.querySelector("#addName").disabled  = true;
    //dodawnie niku do markera
     marker.setTitle( nick );
})


//funkcja wyswietlająca wspołrzedne
function displayPosition()
{
    document.querySelector("#Lat").innerHTML  = position.lat.toFixed(2) ;
    document.querySelector("#Lng").innerHTML  =  position.lng.toFixed(2);
}

//funkcja zmieniająca awatar
document.querySelector("#addAvatar").addEventListener('click',  ()=>{
   
    markerSrc = document.querySelector("#avatarSrc").value;
    AvatarImg = 
    {
        url: markerSrc,
        scaledSize: new google.maps.Size( 27 ,43),
        
    };
    marker.setIcon( AvatarImg );


});

//funkcja reagujoca na wciśniecie przycisku send i wysyłająca widomość
document.querySelector("#sendMessage").addEventListener('click',  ()=>
{
    addMessage();




}
)


///funkcja dodająca wiadomość do chatBoxa
function addMessage()
{

    let newDiv =  document.createElement('div');
    newDiv.className = "massage";
    newDiv.innerHTML = '<h6 class = "PlayerNick">'+nick+':</h6>  <p class="PlayerText">'+document.querySelector("#textMessage").value+'</p>';
    document.querySelector("#textMessage").value = " ";
    document.querySelector("#czat").appendChild(newDiv);
}
//websocket/////////////////////////////////////
function startWebSocket() {
    let url = 'ws://echo.websocket.org'
    ws = new WebSocket(url)
    ws.addEventListener('open', onWSOpen)
    ws.addEventListener('message', onWSMessage)
}

function onWSOpen(data) {
    console.log(data)
    
}
function onWSMessage(e) {
    
    
   
   
    let data = JSON.parse(e.data);
    console.log(data);


    if (!players[ data.id]) {
        players[ data.id] = new google.maps.Marker({
            position: { lat: data.lat, lng: data.lng },
            map: map,
            animation: google.maps.Animation.DROP
        })
    } else {
        players[data.id].setPosition({
            lat: data.lat,
            lng: data.lng
        })
    }
}

// mapa /////////////////////////////////////////////////
// tworzenie i wyświetlenie mapy
function mapaStart()   
{   
    
    position = { lat: 50, lng: 50 };
    // The map, centered at position
    map = new google.maps.Map(document.querySelector("#mapView"),
        {
            zoom: 5,
            center: position,
            styles: [{ "elementType": "labels", "stylers": [{ "visibility": "off" }, { "color": "#f49f53" }] }, { "featureType": "landscape", "stylers": [{ "color": "#f9ddc5" }, { "lightness": -7 }] }, { "featureType": "road", "stylers": [{ "color": "#813033" }, { "lightness": 43 }] }, { "featureType": "poi.business", "stylers": [{ "color": "#645c20" }, { "lightness": 38 }] }, { "featureType": "water", "stylers": [{ "color": "#1994bf" }, { "saturation": -69 }, { "gamma": 0.99 }, { "lightness": 43 }] }, { "featureType": "road.local", "elementType": "geometry.fill", "stylers": [{ "color": "#f19f53" }, { "weight": 1.3 }, { "visibility": "on" }, { "lightness": 16 }] }, { "featureType": "poi.business" }, { "featureType": "poi.park", "stylers": [{ "color": "#645c20" }, { "lightness": 39 }] }, { "featureType": "poi.school", "stylers": [{ "color": "#a95521" }, { "lightness": 35 }] }, {}, { "featureType": "poi.medical", "elementType": "geometry.fill", "stylers": [{ "color": "#813033" }, { "lightness": 38 }, { "visibility": "off" }] }, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, { "elementType": "labels" }, { "featureType": "poi.sports_complex", "stylers": [{ "color": "#9e5916" }, { "lightness": 32 }] }, {}, { "featureType": "poi.government", "stylers": [{ "color": "#9e5916" }, { "lightness": 46 }] }, { "featureType": "transit.station", "stylers": [{ "visibility": "off" }] }, { "featureType": "transit.line", "stylers": [{ "color": "#813033" }, { "lightness": 22 }] }, { "featureType": "transit", "stylers": [{ "lightness": 38 }] }, { "featureType": "road.local", "elementType": "geometry.stroke", "stylers": [{ "color": "#f19f53" }, { "lightness": -10 }] }, {}, {}, {}],
            disableDefaultUI: true,
            zoomControl: true,

        });

    marker = new google.maps.Marker({ position: position, map: map, animation: google.maps.Animation.DROP, })



    startWebSocket();
}   



</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyARkS-dsh-7IirtcQg3oSZEHudV6Uw9Iic&callback=mapaStart" async
defer>
</script>

</html>